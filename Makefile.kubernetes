# RabbitMQ Kubernetes Management
# This Makefile provides targets for managing RabbitMQ in Kubernetes

.PHONY: k8s-help rabbitmq-setup rabbitmq-teardown rabbitmq-status rabbitmq-logs rabbitmq-shell rabbitmq-port-forward rabbitmq-cleanup rabbitmq-connection-info

# Default target
k8s-help: ## Show Kubernetes help message
	@echo "RabbitMQ Kubernetes Management"
	@echo "=============================="
	@echo ""
	@echo "Available targets:"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  %-20s %s\n", $$1, $$2}' $(MAKEFILE_LIST)

rabbitmq-setup: ## Deploy RabbitMQ to Kubernetes
	@echo "=============================================="
	@echo "Setting up RabbitMQ in Kubernetes..."
	@echo "=============================================="
	@echo ""
	@echo "ðŸ“¦ Step 1/6: Creating namespace..."
	@kubectl apply -f namespace.yaml || (echo "âŒ Failed to create namespace" && exit 1)
	@echo "âœ… Namespace created/updated"
	@echo ""
	@echo "ðŸ“¦ Step 2/6: Creating ConfigMap..."
	@kubectl apply -f configmap.yaml || (echo "âŒ Failed to create ConfigMap" && exit 1)
	@echo "âœ… ConfigMap created/updated"
	@kubectl get configmap rabbitmq-config -n rabbitmq-system
	@echo ""
	@echo "ðŸ“¦ Step 3/6: Creating PersistentVolumeClaim..."
	@kubectl apply -f pvc.yaml || (echo "âŒ Failed to create PVC" && exit 1)
	@echo "âœ… PVC created/updated"
	@kubectl get pvc rabbitmq-data -n rabbitmq-system
	@echo "   Waiting for PVC to be bound..."
	@timeout=60; \
	while [ $$timeout -gt 0 ] && ! kubectl get pvc rabbitmq-data -n rabbitmq-system -o jsonpath='{.status.phase}' | grep -q Bound; do \
		echo "   PVC status: $$(kubectl get pvc rabbitmq-data -n rabbitmq-system -o jsonpath='{.status.phase}')"; \
		sleep 2; \
		timeout=$$((timeout-2)); \
	done; \
	if kubectl get pvc rabbitmq-data -n rabbitmq-system -o jsonpath='{.status.phase}' | grep -q Bound; then \
		echo "âœ… PVC is bound"; \
	else \
		echo "âš ï¸  PVC not bound yet, continuing anyway..."; \
	fi
	@echo ""
	@echo "ðŸ“¦ Step 4/6: Creating Deployment..."
	@kubectl apply -f deployment.yaml || (echo "âŒ Failed to create deployment" && exit 1)
	@echo "âœ… Deployment created/updated"
	@echo "   Waiting for pods to be created..."
	@sleep 3
	@kubectl get pods -n rabbitmq-system -l app.kubernetes.io/name=rabbitmq
	@echo ""
	@echo "ðŸ“¦ Step 5/6: Creating Services..."
	@kubectl apply -f services.yaml || (echo "âŒ Failed to create services" && exit 1)
	@echo "âœ… Services created/updated"
	@kubectl get svc -n rabbitmq-system
	@echo ""
	@echo "ðŸ“¦ Step 6/6: Checking Prometheus Operator..."
	@if kubectl get crd servicemonitors.monitoring.coreos.com >/dev/null 2>&1; then \
		echo "âœ… Prometheus Operator detected, applying ServiceMonitor..."; \
		kubectl apply -f servicemonitor.yaml || echo "âš ï¸  Failed to create ServiceMonitor"; \
	else \
		echo "â„¹ï¸  Prometheus Operator not found, skipping ServiceMonitor creation."; \
		echo "   To enable monitoring, install Prometheus Operator first."; \
	fi
	@echo ""
	@echo "â³ Waiting for RabbitMQ deployment to be ready (this may take a few minutes)..."
	@echo "   Monitoring pod status..."
	@timeout=300; \
	interval=10; \
	while [ $$timeout -gt 0 ]; do \
		if kubectl wait --for=condition=available --timeout=$${interval}s deployment/rabbitmq -n rabbitmq-system 2>/dev/null; then \
			echo "âœ… RabbitMQ deployment is ready!"; \
			break; \
		fi; \
		echo ""; \
		echo "   Current status ($$((300-timeout))s elapsed):"; \
		kubectl get pods -n rabbitmq-system -l app.kubernetes.io/name=rabbitmq -o wide || true; \
		echo ""; \
		pod_name=$$(kubectl get pods -n rabbitmq-system -l app.kubernetes.io/name=rabbitmq -o jsonpath='{.items[0].metadata.name}' 2>/dev/null); \
		if [ -n "$$pod_name" ]; then \
			echo "   Pod events:"; \
			kubectl get events -n rabbitmq-system --field-selector involvedObject.name=$$pod_name --sort-by='.lastTimestamp' | tail -3 || true; \
			echo ""; \
			echo "   Pod conditions:"; \
			kubectl get pod $$pod_name -n rabbitmq-system -o jsonpath='{range .status.conditions[*]}{.type}: {.status} ({.reason}){end}{"\n"}' || true; \
		fi; \
		timeout=$$((timeout-interval)); \
		if [ $$timeout -le 0 ]; then \
			echo ""; \
			echo "âŒ Timeout waiting for RabbitMQ to be ready!"; \
			echo ""; \
			echo "ðŸ“‹ Debugging information:"; \
			echo "   Pod status:"; \
			kubectl get pods -n rabbitmq-system -l app.kubernetes.io/name=rabbitmq -o wide || true; \
			echo ""; \
			pod_name=$$(kubectl get pods -n rabbitmq-system -l app.kubernetes.io/name=rabbitmq -o jsonpath='{.items[0].metadata.name}' 2>/dev/null); \
			if [ -n "$$pod_name" ]; then \
				echo "   Pod describe:"; \
				kubectl describe pod $$pod_name -n rabbitmq-system | tail -30 || true; \
				echo ""; \
				echo "   Recent pod logs:"; \
				kubectl logs $$pod_name -n rabbitmq-system --tail=50 || true; \
			fi; \
			echo ""; \
			echo "   Deployment describe:"; \
			kubectl describe deployment rabbitmq -n rabbitmq-system | tail -20 || true; \
			exit 1; \
		fi; \
		sleep $$interval; \
	done
	@echo ""
	@echo "âœ… RabbitMQ is ready!"
	@echo ""
	@$(MAKE) rabbitmq-connection-info

rabbitmq-teardown: ## Remove RabbitMQ from Kubernetes
	@echo "Tearing down RabbitMQ..."
	@if kubectl get crd servicemonitors.monitoring.coreos.com >/dev/null 2>&1; then \
		echo "Prometheus Operator detected, deleting ServiceMonitor..."; \
		kubectl delete -f servicemonitor.yaml --ignore-not-found=true; \
	else \
		echo "Prometheus Operator not found, skipping ServiceMonitor deletion."; \
	fi
	kubectl delete -f services.yaml --ignore-not-found=true
	kubectl delete -f deployment.yaml --ignore-not-found=true
	kubectl delete -f pvc.yaml --ignore-not-found=true
	kubectl delete -f configmap.yaml --ignore-not-found=true
	kubectl delete -f namespace.yaml --ignore-not-found=true
	@echo "RabbitMQ has been removed from Kubernetes"

rabbitmq-status: ## Show RabbitMQ status
	@echo "RabbitMQ Status:"
	@echo "================"
	kubectl get pods -n rabbitmq-system -l app.kubernetes.io/name=rabbitmq
	@echo ""
	kubectl get svc -n rabbitmq-system
	@echo ""
	kubectl get pvc -n rabbitmq-system

rabbitmq-logs: ## Show RabbitMQ logs
	kubectl logs -f deployment/rabbitmq -n rabbitmq-system

rabbitmq-shell: ## Access RabbitMQ shell
	kubectl exec -it deployment/rabbitmq -n rabbitmq-system -- rabbitmqctl

rabbitmq-port-forward: ## Port forward RabbitMQ services for local access
	@echo "Port forwarding RabbitMQ services..."
	@echo "AMQP (Message Queue): localhost:5672"
	@echo "Management UI: http://localhost:15672"
	@echo "Prometheus metrics: http://localhost:15692/metrics"
	@echo "Press Ctrl+C to stop port forwarding"
	kubectl port-forward svc/rabbitmq 5672:5672 15672:15672 15692:15692 -n rabbitmq-system

rabbitmq-connection-info: ## Show RabbitMQ NodePort connection information
	@./scripts/get-nodeport-info.sh

rabbitmq-cleanup: ## Clean up all RabbitMQ resources (including data)
	@echo "WARNING: This will delete all RabbitMQ data permanently!"
	@read -p "Are you sure? (y/N): " confirm && [ "$$confirm" = "y" ]
	kubectl delete pvc rabbitmq-data -n rabbitmq-system --ignore-not-found=true
	$(MAKE) rabbitmq-teardown
